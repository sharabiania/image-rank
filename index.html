<html>
	<head>
		<style>
			img {border: 1px solid black;}
			img:hover {border: 1px solid green;}
		</style>
		<link href="mg.css" rel="stylesheet" type="text/css"/>
		<script src="mg.js"></script>
	</head>
	<body>
		<div style="text-align: center;">
			<h1 id='title'></h1>
			
			<div class="img-magnifier-container">
				<img id="img-left" width="300" height="200" />		
			</div>			
			<div class="img-magnifier-container">
				<img id='img-right' width="300" height="200"/>
			</div>
			<br/>
			<div id="panel">
				<button onclick="leftClick()">Left is better</button>
				<button onclick="rightClick()">Right is better</button>
			</div>
			<table id='table'></table>
		
		</div>
		
		<script>
			const TOTAL_IMAGES = 2;
			const TOTAL_METHODS = 5;
			var imgSet = [];
			for(var i = 0; i < TOTAL_IMAGES; ++i) imgSet.push([]);			
			var currSet = [];
			var currSetIndex = 0;
			var winners = [];
			var currWinner = null;
			var imgLeft = document.getElementById("img-left");
			var imgRight = document.getElementById("img-right");
			var buttonPanel = document.getElementById('panel');
			var li = 0, ri = 1;
			var endFlag = false;
			var title = document.getElementById('title');
			
			imgLeft.addEventListener('load', function(){buttonPanel.hidden = '';});
			imgRight.addEventListener('load',function(){buttonPanel.hidden = '';});


			function loadImage(el, src){
				buttonPanel.hidden = 'hidden';
				el.src = "";
				el.src = src;
			}

			var img = function(name, method) {
				this.name = name;
				this.method = method;
			}
			img.prototype.src = function() {
				return "images/img" + this.name + this.method + ".png";
			}
			img.prototype.tag = function(){				
				return "image " + this.name + " method " + this.method;
			}

			function shuffle(a) {
				var j, x, i;
				for (i = a.length - 1; i > 0; i--) {
					j = Math.floor(Math.random() * (i + 1));
					x = a[i];
					a[i] = a[j];
					a[j] = x;
				}
				return a;
			}


			// initialize data set
			
			for(var i = 0; i < TOTAL_IMAGES; ++i) {
				for(var j = 0; j < TOTAL_METHODS; ++j) {	
					imgSet[i][j] = new img(i + 1, j + 1);				
				}
			}
			currSet = imgSet[0];
			reset();
			
			// END initialize.

			function reset() {
		
				if(currSet.length == 2) {
					if(currWinner != null) {
						winners.push(currWinner);
						var index = currSet.indexOf(currWinner);
						currSet.splice(index, 1);
						console.log(currWinner.tag() + ' is out!');
						currWinner = null;
						winners.push(currSet[0]);
					}
					var table = document.getElementById('table');
					for(var i = 0; i < winners.length; i++) {
						var tr = document.createElement('tr');
						var td = document.createElement('td');					
						td.innerText = winners[i].tag();
						tr.appendChild(td);
						table.appendChild(tr);
					}

					return;
				}

				if(currSet.length > 2) {
					if(currWinner != null) {
						winners.push(currWinner);
						var index = currSet.indexOf(currWinner);
						currSet.splice(index, 1);
						console.log(currWinner.tag() + ' is out!');
						currWinner = null;
					}
					currSet = shuffle(currSet);
					title.innerText = "Image " + (currSetIndex + 1) + " Round " + (TOTAL_METHODS - currSet.length + 1);									
					loadImage(imgLeft, currSet[0].src());
					loadImage(imgRight, currSet[1].src());
					endFlag = false;
					li = 0;
					ri = 1;
					return;
				}			
							
			}

			function end() {
				if(endFlag || currSetIndex >= TOTAL_METHODS) {
					// Change the data set
					currSetIndex++;
					if(currSetIndex >= TOTAL_IMAGES) currSetIndex = 0
					else {
						currSet = imgSet[currSetIndex];
						endFlag = false;
						reset();
					}
					return;										
				}
				title.innerText = title.innerText + ": Winner is " + currWinner.tag();
				endFlag = true;
				reset();
			}
	
			function leftClick() {		
				currWinner = currSet[li];							

				// choose a new ri
				if(ri < li) ri = li + 1;
				else ri++;													
				if(ri > currSet.length - 1) {
					ri = currSet.length - 1;
					end();
				}
				else {		
					loadImage(imgRight, currSet[ri].src());					
				}
				
			}
			function rightClick(){
			
				currWinner = currSet[ri];

				// choose a new li
				if(li < ri) li = ri + 1;
				else li++;

				if(li > currSet.length - 1) {
					li = currSet.length - 1;
					end();
				}
				else{					
					loadImage(imgLeft, currSet[li].src());	
				}
				
				
			}

			magnify("img-left", 2);
			magnify("img-right", 2);
		</script>
	</body>
</html>